version: '2.1'

services:

  lb:
    image: camptocamp/haproxy-consul:latest
    container_name: 'load-balancer'
    environment:
      HAPROXY_DOMAIN: '127.0.0.1.xip.io:test'
      SERVICE_80_IGNORE: 'yes'
      SERVICE_8080_NAME: 'proxy-admin_infra'
    ports:
      - "80:80"
      - "8080"
    links:
      - "consul"

  # Only one for the whole cluster
  consul:
    command: -server -bootstrap
    image: progrium/consul:latest
    container_name: 'consul'
    environment:
      SERVICE_8500_NAME: 'consul-admin_infra'
      SERVICE_53_IGNORE: 'yes'
      SERVICE_8300_IGNORE: 'yes'
      SERVICE_8301_IGNORE: 'yes'
      SERVICE_8302_IGNORE: 'yes'
      SERVICE_8400_IGNORE: 'yes'

  # Exactly one per physical node
  registrator:
    command: "-internal consul://consul:8500"
    image: gliderlabs/registrator:latest
    container_name: 'registrator'
    links:
      - "consul"
    volumes:
      - "/var/run/docker.sock:/tmp/docker.sock"

  ignite:
    image: codeunited/ignite-showcase:1.0.0
    environment:
      SERVICE_28080_NAME: 'data-grid'
      SERVICE_11211_IGNORE: 'yes'
      SERVICE_47100_IGNORE: 'yes'
      SERVICE_47500_IGNORE: 'yes'
      SERVICE_49112_IGNORE: 'yes'

#  mongodb:
#    image: mongo:3.4.10
#    volumes:
#      - "/tmp/mongo:/data/db"
#
#  backend:
#    image: apacheignite/web-console-backend
#    ports:
#      - 3001:3001
#    restart: on-failure
#    environment:
#      # Port for serving frontend API
#      - server_port=3000
#      # Cookie session secret
#      - server_sessionSecret=CHANGE ME
#      # URL for mongodb connection
#      - mongodb_url=mongodb://mongodb/console
#      # Port for web-agent.
#      - agentServer_port=3001
#      # Mail connection settings. Leave empty if no needed. See also settings, https://github.com/nodemailer/nodemailer
#      - mail_service=
#      - mail_sign=
#      - mail_greeting=
#      - mail_from=
#      - mail_auth_user=
#      - mail_auth_pass=
#
#  frontend:
#    image: apacheignite/web-console-frontend
#    links:
#      # Link backend container to proxy backend requests throught nginx container.
#      - backend:backend
#
#    ports:
#      - 81:80
